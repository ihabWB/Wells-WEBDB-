<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Wells Database- (PWA)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#0e7490" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="./styles.css" />
  <!-- Map-specific minimal styles -->
  <style>
    #map { width:100%; height:62vh; border:1px solid #ccc; border-radius:10px; }
    .hint { color:#7b8a9a; font-size:0.9rem; }
  </style>
  <!-- Libraries -->
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/proj4@2.10.0/dist/proj4.js"></script>
  <!-- App scripts -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="./config.js"></script>
  <script defer src="./app.js"></script>
  <!-- Reports dependencies -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script defer src="./reports.js"></script>
</head>
<body class="theme-ocean">
  <header>
    <h1> PWA Groundwater Wells -DATABASE</h1>
    <div class="status">
      <span id="netStatus">Offline</span>
      <button id="btnSync" type="button">Sync Now</button>
    </div>
  </header>

  <nav class="tabs">
    <button class="tab active" data-tab="wells">Wells</button>
    <button class="tab" data-tab="readings">Monthly Readings</button>
    <button class="tab" data-tab="quality">Water Quality</button>
    <button class="tab" data-tab="maintenance">Maintenance</button>
    <button class="tab" data-tab="service">Service Areas</button>
    <button class="tab" data-tab="list">List Wells</button>
    <button class="tab" data-tab="mapPanel">Map</button>
    <!-- NEW reporting tabs -->
    <button class="tab" data-tab="readingList">Readings List</button>
    <button class="tab" data-tab="reports">Reports</button>
  </nav>

  <main>
    <section id="wells" class="panel active">
      <h2>Add Well</h2>
      <form id="formWell">
        <div class="field">
          <label>Well Code*</label>
          <input name="well_code" required />
        </div>

        <div class="field">
          <label>Well Name</label>
          <input name="well_name" />
        </div>

        <div class="grid-3">
          <div class="field">
            <label>Governorate</label>
            <select name="governorate">
              <option value="">— Select —</option>
              <option>Tubas</option>
              <option>Tulkarm</option>
              <option>Nablus</option>
              <option>Qalqiliya</option>
              <option>Salfit</option>
              <option>Ramallah &amp; Al-Bireh</option>
              <option>Jericho &amp; Al Aghwar</option>
              <option>Jerusalem</option>
              <option>Bethlehem</option>
              <option>Hebron</option>
            </select>
          </div>
          <div class="field">
            <label>District</label>
            <input name="district" />
          </div>
          <div class="field">
            <label>Village</label>
            <input name="village" />
          </div>
        </div>

        <div class="grid-3">
          <div class="field">
            <label>X (EPSG:28191)</label>
            <input name="x" type="number" step="any" />
          </div>
          <div class="field">
            <label>Y (EPSG:28191)</label>
            <input name="y" type="number" step="any" />
          </div>
          <div class="field">
            <label>Z (Elevation)</label>
            <input name="z" type="number" step="any" />
          </div>
        </div>
        <p class="hint">Note: X,Y are in EPSG:28191 (Palestine 1923 grid). They’ll be converted to WGS84 on the map.</p>

        <div class="grid-2">
          <div class="field">
            <label>Owner / Service Provider</label>
            <input name="owner_service_provider" />
          </div>
          <div class="field">
            <label>Aquifer</label>
            <select name="aquifer">
              <option value="">— Select —</option>
              <option>Western</option>
              <option>Eastern</option>
              <option>North-Eastern</option>
            </select>
          </div>
        </div>

        <div class="grid-3">
          <div class="field">
            <label>Well Type</label>
            <select name="well_type">
              <option value="">—</option>
              <option>Production</option>
              <option>Monitoring</option>
              <option>Agricultural</option>
              <option>Domestic</option>
              <option>Industrial</option>
            </select>
          </div>
          <div class="field">
            <label>Drilling Year</label>
            <input name="drilling_year" type="number" min="1900" max="2100" />
          </div>
          <div class="field">
            <label>Status</label>
            <select name="current_status">
              <option value="">—</option>
              <option>Active</option>
              <option>Inactive</option>
              <option>Under Repair</option>
              <option>Abandoned</option>
            </select>
          </div>
        </div>

        <div class="grid-3">
          <div class="field">
            <label>Well Depth (m)</label>
            <input name="well_depth_m" type="number" step="any" />
          </div>
          <div class="field">
            <label>Casing Depth (m)</label>
            <input name="casing_depth_m" type="number" step="any" />
          </div>
          <div class="field">
            <label>Pump Type</label>
            <input name="pump_type" />
          </div>
        </div>

        <div class="grid-2">
          <div class="field">
            <label>Pump Capacity (m³/hr)</label>
            <input name="pump_capacity_m3_per_hr" type="number" step="any" />
          </div>
          <div class="field">
            <label>Design Capacity (m³/year)</label>
            <input name="design_capacity_m3_per_year" type="number" step="any" />
          </div>
        </div>

        <div class="field">
          <label>Remarks</label>
          <textarea name="remarks"></textarea>
        </div>

        <button type="submit">Save Well</button>
        <div class="msg" id="msgWell"></div>
      </form>
    </section>

    <section id="readings" class="panel">
      <h2>Add Monthly Reading</h2>
      <form id="formReading">
        <div class="field">
          <label>Well*</label>
          <select id="readingWell" name="well_id" required></select>
        </div>
        <div class="grid-3">
          <div class="field">
            <label>Reading Date*</label>
            <input name="reading_date" type="date" required />
          </div>
          <div class="field">
            <label>Meter Last (m³)*</label>
            <input name="meter_last_m3" type="number" step="any" required />
          </div>
          <div class="field">
            <label>Meter Current (m³)*</label>
            <input name="meter_current_m3" type="number" step="any" required />
          </div>
        </div>
        <div class="grid-3">
          <div class="field">
            <label>Static Water Level (m)</label>
            <input name="static_water_level_m" type="number" step="any" />
          </div>
          <div class="field">
            <label>Dynamic Water Level (m)</label>
            <input name="dynamic_water_level_m" type="number" step="any" />
          </div>
          <div class="field">
            <label>Pumping Hours</label>
            <input name="pumping_hours" type="number" step="any" />
          </div>
        </div>
        <div class="field">
          <label>Notes</label>
          <textarea name="notes"></textarea>
        </div>
        <div class="field">
          <label>Monthly Abstraction (auto)</label>
          <input id="computedAbstraction" disabled />
        </div>
        <button type="submit">Save Reading</button>
        <div class="msg" id="msgReading"></div>
      </form>
    </section>

    <section id="quality" class="panel">
      <h2>Add Water Quality</h2>
      <form id="formQuality">
        <div class="field">
          <label>Well*</label>
          <select id="qualityWell" name="well_id" required></select>
        </div>
        <div class="grid-3">
          <div class="field">
            <label>Sample Date*</label>
            <input name="sample_date" type="date" required />
          </div>
          <div class="field">
            <label>Parameter Name*</label>
            <input name="parameter_name" required placeholder="e.g., EC, pH, TDS" />
          </div>
          <div class="field">
            <label>Value</label>
            <input name="parameter_value" type="number" step="any" />
          </div>
        </div>
        <div class="grid-3">
          <div class="field">
            <label>Unit</label>
            <input name="unit" placeholder="e.g., µS/cm, pH, mg/L" />
          </div>
          <div class="field">
            <label>Sampling Agency</label>
            <input name="sampling_agency" />
          </div>
          <div class="field">
            <label>Technician</label>
            <input name="technician" />
          </div>
        </div>
        <div class="field">
          <label>Remarks</label>
          <textarea name="remarks"></textarea>
        </div>
        <button type="submit">Save Quality</button>
        <div class="msg" id="msgQuality"></div>
      </form>
    </section>

    <section id="maintenance" class="panel">
      <h2>Add Maintenance Visit</h2>
      <form id="formMaintenance">
        <div class="field">
          <label>Well*</label>
          <select id="maintenanceWell" name="well_id" required></select>
        </div>
        <div class="grid-3">
          <div class="field">
            <label>Visit Date*</label>
            <input name="visit_date" type="date" required />
          </div>
          <div class="field">
            <label>Technician / Team</label>
            <input name="technician_team" />
          </div>
          <div class="field">
            <label>Activity</label>
            <input name="activity" placeholder="Repair, Cleaning, Pump Replacement, etc." />
          </div>
        </div>
        <div class="field">
          <label>Notes</label>
          <textarea name="notes"></textarea>
        </div>
        <div class="field">
          <label>Cost</label>
          <input name="cost" type="number" step="any" />
        </div>
        <button type="submit">Save Visit</button>
        <div class="msg" id="msgMaintenance"></div>
      </form>
    </section>

    <section id="service" class="panel">
      <h2>Add Service Area</h2>
      <form id="formService">
        <div class="field">
          <label>Well*</label>
          <select id="serviceWell" name="well_id" required></select>
        </div>
        <div class="grid-2">
          <div class="field">
            <label>Community / Facility</label>
            <input name="community_facility" />
          </div>
          <div class="field">
            <label>Population Served</label>
            <input name="population_served" type="number" step="1" />
          </div>
        </div>
        <div class="field">
          <label>Water Demand (m³/month)</label>
          <input name="water_demand_m3_per_month" type="number" step="any" />
        </div>
        <button type="submit">Save Service Area</button>
        <div class="msg" id="msgService"></div>
      </form>
    </section>

    <section id="list" class="panel">
      <h2>Wells List</h2>
      <div class="filters">
        <input id="filterText" placeholder="Search by code or name" />
        <button id="btnRefresh">Refresh</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Code</th>
            <th>Name</th>
            <th>Location</th>
            <th>Aquifer</th>
            <th>Type</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tblWells"></tbody>
      </table>
      <p class="hint">Tip: Add wells first so they appear in the dropdowns for other forms.</p>
    </section>

    <section id="mapPanel" class="panel">
      <h2>Wells Map</h2>
      <div id="map"></div>
      <p class="hint">Coordinates are stored as EPSG:28191 and converted to WGS84 for display.</p>
    </section>

    <!-- NEW: Readings List by Well -->
    <section id="readingList" class="panel">
      <h2>Readings List by Well</h2>
      <div class="filters">
        <select id="readingListWell"></select>
        <input id="readingListFrom" type="date" />
        <input id="readingListTo" type="date" />
        <button id="btnReadingListLoad" class="btn">Load</button>
        <button id="btnReadingListCSV" class="btn btn-secondary">Export CSV</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Meter Last (m³)</th>
              <th>Meter Current (m³)</th>
              <th>Abstraction (m³)</th>
              <th>Static WL (m)</th>
              <th>Dynamic WL (m)</th>
              <th>Pumping Hrs</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="tblReadingList"></tbody>
        </table>
      </div>
      <p class="hint" id="readingListSummary"></p>
    </section>

    <!-- NEW: Reports -->
    <section id="reports" class="panel">
      <h2>Operational & Compliance Reports</h2>

      <!-- A) Monthly Abstraction per Well -->
      <div class="panel-inner card" style="margin-bottom:14px;">
        <h3 style="margin:0 0 10px;">Monthly Abstraction per Well</h3>
        <div class="filters">
          <select id="rptAWell"></select>
          <input id="rptAStartMonth" type="month" />
          <input id="rptAEndMonth" type="month" />
          <button id="btnRptALoad" class="btn">Load</button>
          <button id="btnRptACSV" class="btn btn-secondary">Export CSV</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Well</th>
                <th>Location</th>
                <th>Year</th>
                <th>Month</th>
                <th>Abstraction (m³)</th>
                <th>Allowed (m³/mo)</th>
                <th>% of Allowed</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="tblRptA"></tbody>
          </table>
        </div>
        <p class="hint" id="rptASummary"></p>
      </div>

      <!-- B) Total Abstraction per Area -->
      <div class="panel-inner card" style="margin-bottom:14px;">
        <h3 style="margin:0 0 10px;">Total Abstraction per Area</h3>
        <div class="filters">
          <select id="rptBGroupBy">
            <option value="governorate">Governorate</option>
            <option value="district">District</option>
            <option value="owner_service_provider">Service Provider</option>
          </select>
          <input id="rptBStartMonth" type="month" />
          <input id="rptBEndMonth" type="month" />
          <button id="btnRptBLoad" class="btn">Load</button>
          <button id="btnRptBCSV" class="btn btn-secondary">Export CSV</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Group</th>
                <th>Total Abstraction (m³)</th>
              </tr>
            </thead>
            <tbody id="tblRptB"></tbody>
          </table>
        </div>
      </div>

      <!-- C) Non-Operational Wells -->
      <div class="panel-inner card" style="margin-bottom:14px;">
        <h3 style="margin:0 0 10px;">Non-Operational Wells</h3>
        <div class="filters">
          <input id="rptCDays" type="number" min="1" step="1" placeholder="Days without reading (default 45)" />
          <button id="btnRptCLoad" class="btn">Load</button>
          <button id="btnRptCCSV" class="btn btn-secondary">Export CSV</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Well</th>
                <th>Governorate</th>
                <th>District</th>
                <th>Status</th>
                <th>Last Reading</th>
                <th>Reason</th>
              </tr>
            </thead>
            <tbody id="tblRptC"></tbody>
          </table>
        </div>
        <p class="hint">Lists wells inactive (status != Active) or with missing readings in the specified number of days.</p>
      </div>

      <!-- D) Maintenance Logs -->
      <div class="panel-inner card" style="margin-bottom:14px;">
        <h3 style="margin:0 0 10px;">Maintenance Logs</h3>
        <div class="filters">
          <select id="rptDWell"></select>
          <input id="rptDFrom" type="date" />
          <input id="rptDTo" type="date" />
          <button id="btnRptDLoad" class="btn">Load</button>
          <button id="btnRptDCSV" class="btn btn-secondary">Export CSV</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Well</th>
                <th>Technician/Team</th>
                <th>Activity</th>
                <th>Notes</th>
                <th>Cost</th>
              </tr>
            </thead>
            <tbody id="tblRptD"></tbody>
          </table>
        </div>
      </div>

      <!-- E) Water Quality -->
      <div class="panel-inner card" style="margin-bottom:14px;">
        <h3 style="margin:0 0 10px;">Water Quality</h3>
        <div class="filters">
          <select id="rptEParam">
            <option value="EC">EC</option>
            <option value="pH">pH</option>
            <option value="TDS">TDS</option>
            <option value="Nitrate">Nitrate</option>
            <option value="Chloride">Chloride</option>
          </select>
          <select id="rptELevel">
            <option value="">All Areas</option>
            <option value="governorate">By Governorate</option>
            <option value="district">By District</option>
          </select>
          <input id="rptEFrom" type="date" />
          <input id="rptETo" type="date" />
          <button id="btnRptELoad" class="btn">Load</button>
          <button id="btnRptECSV" class="btn btn-secondary">Export CSV</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Well</th>
                <th>Area</th>
                <th>Sample Date</th>
                <th>Parameter</th>
                <th>Value</th>
                <th>Unit</th>
                <th>Compliance</th>
              </tr>
            </thead>
            <tbody id="tblRptE"></tbody>
          </table>
        </div>
        <canvas id="chartQuality" height="120"></canvas>
        <p class="hint">Compliance uses standards if defined; alerts highlight sudden deterioration.</p>
      </div>

      <!-- F) Over-abstraction -->
      <div class="panel-inner card" style="margin-bottom:14px;">
        <h3 style="margin:0 0 10px;">Over-Abstraction</h3>
        <div class="filters">
          <input id="rptFStartMonth" type="month" />
          <input id="rptFEndMonth" type="month" />
          <button id="btnRptFLoad" class="btn">Load</button>
          <button id="btnRptFCSV" class="btn btn-secondary">Export CSV</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Well</th>
                <th>Year</th>
                <th>Month</th>
                <th>Abstraction (m³)</th>
                <th>Allowed (m³/mo)</th>
                <th>Excess (m³)</th>
                <th>% Over</th>
              </tr>
            </thead>
            <tbody id="tblRptF"></tbody>
          </table>
        </div>
      </div>

      <!-- G) Groundwater Level Trends -->
      <div class="panel-inner card" style="margin-bottom:14px;">
        <h3 style="margin:0 0 10px;">Groundwater Level Trends</h3>
        <div class="filters">
          <select id="rptGWell"></select>
          <input id="rptGFrom" type="date" />
          <input id="rptGTo" type="date" />
          <button id="btnRptGLoad" class="btn">Load</button>
        </div>
        <canvas id="chartLevels" height="120"></canvas>
      </div>

      <!-- H) Seasonal Abstraction -->
      <div class="panel-inner card" style="margin-bottom:14px;">
        <h3 style="margin:0 0 10px;">Seasonal Abstraction (Summer vs Winter)</h3>
        <div class="filters">
          <select id="rptHWell"></select>
          <input id="rptHYear" type="number" min="2000" step="1" placeholder="Year (e.g., 2025)" />
          <button id="btnRptHLoad" class="btn">Load</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Well</th>
                <th>Season</th>
                <th>Total Abstraction (m³)</th>
              </tr>
            </thead>
            <tbody id="tblRptH"></tbody>
          </table>
        </div>
      </div>

      <!-- I) Year-to-Year Change -->
      <div class="panel-inner card">
        <h3 style="margin:0 0 10px;">Year-to-Year Change</h3>
        <div class="filters">
          <select id="rptIWell"></select>
          <button id="btnRptILoad" class="btn">Load</button>
          <button id="btnRptICSV" class="btn btn-secondary">Export CSV</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Well</th>
                <th>Year</th>
                <th>Total Abstraction (m³)</th>
                <th>% vs Previous Year</th>
              </tr>
            </thead>
            <tbody id="tblRptI"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <small>Wells PWA -JWC TEAM• Offline capable •Supabase (PostgreSQL)</small>
  </footer>
</body>
</html>
